<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONELOGICA</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Header */
        .header {
            background-color: #101c3d;
            color: white;
            text-align: center;
            padding: 20px;
        }

        /* Form Section */
        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .form-wrapper {
            max-width: 500px;
            width: 100%;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Table Section */
        .table-container {
            margin: 20px auto;
            max-width: 100%;
            padding: 0 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            border: 2px solid #ccc;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #101c3d;
            color: white;
            text-transform: capitalize;
            text-align: -webkit-center; !important
        }
        tbody, td, tfoot, th, thead, tr{
            background-color: #101c3d;
            color: white;
            text-transform: capitalize;
            text-align: -webkit-center; !important
            border-color: #101c3d;
        }
        #result{
            display: none;
        }
        div .title{
            padding-right: 17.5rem;
        }
        /* Responsive Styles */
        @media screen and (max-width: 768px) {
            .form-container {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
        crossorigin="anonymous">
</head>

<body>
    <div class="row header">
        
        <div class="col">
            <nav class="p-1 float-start"><img src="./food/logo1.png" height="52px" width="190px" alt="ONELOGICA"></nav>
            <div class="row">
                <h1 class="title">Image OCR </h1>
            </div>
    </div></div>

    <div class="form-container">
        <div class="form-wrapper">
            <form id="upload-form">
                <input class="form-control mb-2" type="file" id="image-input" accept="image/*" />
                <button class="btn btn-primary" type="submit">Upload and Analyze</button>
            </form>
            <div id="result"></div>
        </div>
    </div>

    <div class="table-container">
        <div id="analysis-result">
            <table>
                <!-- Table content will be generated by JavaScript -->
            </table>
        </div>
    </div>

    <script>
        // Your JavaScript code here
        document
            .getElementById("upload-form")
            .addEventListener("submit", async function (event) {
                event.preventDefault();

                const apiKey = "47160f02bc64433e96747fce737f5fa1";
                const apiUrl =
                    "https://uvw26giknfr.cognitiveservices.azure.com//formrecognizer/documentModels/foodbill1:analyze?api-version=2023-07-31";

                const imageInput = document.getElementById("image-input");
                if (!imageInput.files || imageInput.files.length === 0) {
                    alert("Please select an image file.");
                    return;
                }

                const imageFile = imageInput.files[0];

                try {
                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: {
                            "Ocp-Apim-Subscription-Key": apiKey,
                            "Content-Type": "application/octet-stream",
                        },
                        body: imageFile,
                    });

                    if (response.ok) {
                        const operationLocation =
                            response.headers.get("Operation-Location");
                        document.getElementById(
                            "result"
                        ).innerHTML = `Operation Location: ${operationLocation}`;
                        await waitForAnalysisResult(operationLocation);
                    } else {
                        const errorText = await response.text();
                        document.getElementById(
                            "result"
                        ).innerHTML = `Error: ${errorText}`;
                    }
                } catch (error) {
                    document.getElementById(
                        "result"
                    ).innerHTML = `An error occurred: ${error.message}`;
                }
            });

        async function waitForAnalysisResult(operationLocation) {
            const apiKey = "47160f02bc64433e96747fce737f5fa1";

            try {
                while (true) {
                    const response = await fetch(operationLocation, {
                        headers: {
                            "Ocp-Apim-Subscription-Key": apiKey,
                        },
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log("Response JSON:", result);

                        if (result.status === "succeeded") {
                            const fields = result.analyzeResult.documents[0].fields;

                            const fieldNames = Object.keys(fields);
                            const table = document.createElement("table");
                            const headerRow = document.createElement("tr");

                            fieldNames.forEach((fieldName) => {
                                const th = document.createElement("th");
                                th.textContent = fieldName;
                                headerRow.appendChild(th);
                            });

                            table.appendChild(headerRow);

                            const contentRow = document.createElement("tr");

                            fieldNames.forEach((fieldName) => {
                                const td = document.createElement("td");
                                const field = fields[fieldName];
                                td.textContent = field.content;
                                contentRow.appendChild(td);

                                if (fieldName === "Items" || fieldName === "Tax details") {
                                    const arrayValue = field.valueArray;
                                    if (arrayValue) {
                                        const arrayTable = document.createElement("table");
                                        const arrayTableHeader = document.createElement("tr");

                                        // Add headers based on the first object
                                        const firstObject = arrayValue[0].valueObject;
                                        for (const key in firstObject) {
                                            const arrayTableHeading = document.createElement("th");
                                            arrayTableHeading.textContent = key;
                                            arrayTableHeader.appendChild(arrayTableHeading);
                                        }

                                        arrayTable.appendChild(arrayTableHeader);

                                        // Add rows for each object in the array
                                        arrayValue.forEach((itemData) => {
                                            const objectData = itemData.valueObject;
                                            const arrayRow = document.createElement("tr");

                                            for (const key in objectData) {
                                                const cell = document.createElement("td");
                                                cell.textContent = objectData[key].content || "N/A";
                                                arrayRow.appendChild(cell);
                                            }

                                            arrayTable.appendChild(arrayRow);
                                        });

                                        td.appendChild(arrayTable);
                                    }
                                }
                            });

                            table.appendChild(contentRow);

                            document.getElementById("analysis-result").innerHTML = "";
                            document.getElementById("analysis-result").appendChild(table);

                            break;
                        }
                    }

                    await new Promise((resolve) => setTimeout(resolve, 5000));
                }
            } catch (error) {
                document.getElementById(
                    "analysis-result"
                ).innerHTML = `An error occurred while retrieving analysis result: ${error.message}`;
            }
        }
    </script>
</body>

</html>
